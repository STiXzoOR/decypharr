{{ define "stats" }}
<div class="container mx-auto">
    <div class="flex items-center justify-between mb-6">
        <h1 class="text-3xl font-bold text-primary">System Statistics</h1>
        <button id="refresh-stats" class="btn btn-outline btn-sm">
            <i class="bi bi-arrow-clockwise"></i>
            Refresh
        </button>
    </div>

    <div id="loading-stats" class="text-center py-12">
        <div class="loading loading-spinner loading-lg text-primary"></div>
        <p class="mt-4 text-base-content/70">Loading system statistics...</p>
    </div>

    <div id="stats-content" class="space-y-6" style="display: none;">
        <div class="card bg-base-100 shadow-xl">
            <div class="card-header p-6 pb-3">
                <h2 class="card-title text-xl">
                    <i class="bi bi-cpu text-info"></i>
                    System Overview
                </h2>
            </div>
            <div class="card-body p-6 pt-3">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div class="stat">
                        <div class="stat-figure text-info">
                            <i class="bi bi-memory text-2xl"></i>
                        </div>
                        <div class="stat-title">Memory Used</div>
                        <div class="stat-value text-info" id="memory-used">-</div>
                        <div class="stat-desc" id="heap-alloc">Heap: -</div>
                    </div>
                    <div class="stat">
                        <div class="stat-figure text-success">
                            <i class="bi bi-diagram-3 text-2xl"></i>
                        </div>
                        <div class="stat-title">Goroutines</div>
                        <div class="stat-value text-success" id="goroutines">-</div>
                        <div class="stat-desc" id="gc-cycles">GC: - cycles</div>
                    </div>
                    <div class="stat">
                        <div class="stat-figure text-warning">
                            <i class="bi bi-cpu text-2xl"></i>
                        </div>
                        <div class="stat-title">CPU Cores</div>
                        <div class="stat-value text-warning" id="num-cpu">-</div>
                        <div class="stat-desc" id="arch">-</div>
                    </div>
                    <div class="stat">
                        <div class="stat-figure text-accent">
                            <i class="bi bi-info-circle text-2xl"></i>
                        </div>
                        <div class="stat-title">System</div>
                        <div class="stat-value text-accent" id="os">-</div>
                        <div class="stat-desc" id="go-version">-</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card bg-base-100 shadow-xl" id="debrid-card">
            <div class="card-header p-6 pb-3">
                <h2 class="card-title text-xl">
                    <i class="bi bi-cloud-download text-secondary"></i>
                    Debrid Services
                </h2>
            </div>
            <div class="card-body p-6 pt-3" id="debrid-content">
            </div>
        </div>

        <!-- Enhanced Rclone Status Card -->
        <div class="card bg-base-100 shadow-xl" id="rclone-card">
            <div class="card-body p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="card-title text-xl">
                        <i class="bi bi-cloud-arrow-up-fill text-primary"></i>
                        Rclone Status
                    </h2>
                    <div class="flex items-center gap-3">
                        <span class="badge" id="rclone-status">Loading...</span>
                        <a href="{{.URLBase}}debug/logs/rclone" class="btn btn-sm btn-outline btn-primary" target="_blank">
                            <i class="bi bi-file-text"></i>
                            Logs
                        </a>
                    </div>
                </div>

                <div id="rclone-content">
                    <div class="flex justify-center py-8">
                        <span class="loading loading-spinner loading-lg"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="error-stats" class="alert alert-error" style="display: none;">
        <i class="bi bi-exclamation-triangle-fill"></i>
        <span id="error-message">Failed to load statistics</span>
        <button id="retry-stats" class="btn btn-sm btn-outline">
            <i class="bi bi-arrow-clockwise"></i>
            Retry
        </button>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const loadingEl = document.getElementById('loading-stats');
        const contentEl = document.getElementById('stats-content');
        const errorEl = document.getElementById('error-stats');
        const refreshBtn = document.getElementById('refresh-stats');
        const retryBtn = document.getElementById('retry-stats');

        function formatNumber(num) {
            return num.toLocaleString();
        }

        function showError(message) {
            loadingEl.style.display = 'none';
            contentEl.style.display = 'none';
            errorEl.style.display = 'flex';
            document.getElementById('error-message').textContent = message;
        }

        function showContent() {
            loadingEl.style.display = 'none';
            errorEl.style.display = 'none';
            contentEl.style.display = 'block';
        }

        function showLoading() {
            contentEl.style.display = 'none';
            errorEl.style.display = 'none';
            loadingEl.style.display = 'block';
        }

        function updateRcloneStats(rclone) {
            const statusEl = document.getElementById('rclone-status');
            const contentEl = document.getElementById('rclone-content');

            if (!rclone || !rclone.enabled) {
                statusEl.textContent = 'Disabled';
                statusEl.className = 'badge badge-ghost';
                contentEl.innerHTML = '<p class="text-center opacity-50 py-4">Rclone is not enabled</p>';
                return;
            }

            if (!rclone.server_ready) {
                statusEl.textContent = 'Not Ready';
                statusEl.className = 'badge badge-warning';
                contentEl.innerHTML = '<p class="text-center opacity-50 py-4">Rclone server not ready</p>';
                return;
            }

            // Determine status based on active transfers and errors
            const hasActiveTransfers = rclone.core && rclone.core.transferring && rclone.core.transferring.length > 0;
            const hasErrors = rclone.core && (rclone.core.errors || 0) > 0;

            if (hasErrors) {
                statusEl.textContent = 'Error';
                statusEl.className = 'badge badge-error';
            } else if (hasActiveTransfers) {
                statusEl.textContent = 'Transferring';
                statusEl.className = 'badge badge-info';
            } else {
                statusEl.textContent = 'Active';
                statusEl.className = 'badge badge-success';
            }

            let html = '';

            // Version Info Card
            if (rclone.version) {
                html += `
                    <div class="stats stats-vertical lg:stats-horizontal shadow mb-4 w-full bg-base-200">
                        <div class="stat">
                            <div class="stat-figure text-primary">
                                <i class="bi bi-gear text-2xl"></i>
                            </div>
                            <div class="stat-title">Version</div>
                            <div class="stat-value text-lg">${rclone.version.version || '-'}</div>
                            <div class="stat-desc">${rclone.version.os || ''} / ${rclone.version.arch || ''}</div>
                        </div>
                `;

                // Add uptime to version stats if available
                if (rclone.core) {
                    html += `
                        <div class="stat">
                            <div class="stat-figure text-accent">
                                <i class="bi bi-clock-history text-2xl"></i>
                            </div>
                            <div class="stat-title">Uptime</div>
                            <div class="stat-value text-lg">${window.decypharrUtils.formatDuration(rclone.core.elapsedTime)}</div>
                            <div class="stat-desc">Transfer time: ${window.decypharrUtils.formatDuration(rclone.core.transferTime)}</div>
                        </div>
                    `;
                }

                html += '</div>';
            }

            // Transfer Stats Grid
            if (rclone.core) {
                const cs = rclone.core;
                html += `
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                        <div class="stat bg-base-200 rounded-lg p-3">
                            <div class="stat-title text-xs">Transferred</div>
                            <div class="stat-value text-lg text-primary">${window.decypharrUtils.formatBytes(cs.bytes || 0)}</div>
                        </div>
                        <div class="stat bg-base-200 rounded-lg p-3">
                            <div class="stat-title text-xs">Speed</div>
                            <div class="stat-value text-lg text-info">${window.decypharrUtils.formatBytes(cs.speed || 0)}/s</div>
                        </div>
                        <div class="stat bg-base-200 rounded-lg p-3">
                            <div class="stat-title text-xs">Transfers</div>
                            <div class="stat-value text-lg">${cs.transfers || 0}</div>
                        </div>
                        <div class="stat bg-base-200 rounded-lg p-3">
                            <div class="stat-title text-xs">Errors</div>
                            <div class="stat-value text-lg ${(cs.errors || 0) > 0 ? 'text-error' : ''}">${cs.errors || 0}</div>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                        <div class="stat bg-base-200 rounded-lg p-3">
                            <div class="stat-title text-xs">Checks</div>
                            <div class="stat-value text-lg text-secondary">${cs.checks || 0}</div>
                        </div>
                        <div class="stat bg-base-200 rounded-lg p-3">
                            <div class="stat-title text-xs">Total Checks</div>
                            <div class="stat-value text-lg">${cs.totalChecks || 0}</div>
                        </div>
                        <div class="stat bg-base-200 rounded-lg p-3">
                            <div class="stat-title text-xs">Total Transfers</div>
                            <div class="stat-value text-lg">${cs.totalTransfers || 0}</div>
                        </div>
                        <div class="stat bg-base-200 rounded-lg p-3">
                            <div class="stat-title text-xs">Deletes</div>
                            <div class="stat-value text-lg">${cs.deletes || 0}</div>
                        </div>
                    </div>
                `;

                // Active Transfers List
                if (cs.transferring && cs.transferring.length > 0) {
                    html += `
                        <div class="mb-4">
                            <h3 class="font-semibold mb-2 flex items-center gap-2">
                                <i class="bi bi-arrow-down-up text-primary"></i>
                                Active Transfers (${cs.transferring.length})
                            </h3>
                            <div class="space-y-2 max-h-48 overflow-y-auto">
                    `;

                    cs.transferring.forEach(t => {
                        const progress = t.size > 0 ? ((t.bytes || 0) / t.size * 100) : 0;
                        const eta = t.eta ? window.decypharrUtils.formatDuration(t.eta) : '-';
                        html += `
                            <div class="bg-base-200 rounded-lg p-3">
                                <div class="flex justify-between items-center mb-1">
                                    <span class="text-sm font-medium truncate max-w-[70%]" title="${t.name}">${t.name}</span>
                                    <span class="text-xs opacity-70">${window.decypharrUtils.formatBytes(t.speed || 0)}/s</span>
                                </div>
                                <progress class="progress progress-primary w-full h-2" value="${progress}" max="100"></progress>
                                <div class="flex justify-between text-xs opacity-70 mt-1">
                                    <span>${window.decypharrUtils.formatBytes(t.bytes || 0)} / ${window.decypharrUtils.formatBytes(t.size || 0)}</span>
                                    <span>ETA: ${eta}</span>
                                </div>
                            </div>
                        `;
                    });

                    html += '</div></div>';
                }
            }

            // Mounted Services Grid
            if (rclone.mounts && Object.keys(rclone.mounts).length > 0) {
                html += `
                    <div class="mb-4">
                        <h3 class="font-semibold mb-2 flex items-center gap-2">
                            <i class="bi bi-hdd-network text-success"></i>
                            Mounted Services (${Object.keys(rclone.mounts).length})
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                `;

                Object.entries(rclone.mounts).forEach(([name, mount]) => {
                    const statusBadge = mount.mounted
                        ? '<span class="badge badge-success badge-xs">Mounted</span>'
                        : '<span class="badge badge-error badge-xs">Not Mounted</span>';
                    html += `
                        <div class="bg-base-200 rounded-lg p-3">
                            <div class="flex justify-between items-center">
                                <div>
                                    <span class="font-medium">${mount.config_name || name}</span>
                                    <span class="text-xs opacity-70 ml-2">${mount.provider || ''}</span>
                                </div>
                                ${statusBadge}
                            </div>
                            <div class="text-xs opacity-70 mt-1 font-mono">${mount.local_path || '-'}</div>
                            ${mount.mounted_at ? `<div class="text-xs opacity-50 mt-1">Since: ${new Date(mount.mounted_at).toLocaleString()}</div>` : ''}
                            ${mount.error ? `<div class="text-xs text-error mt-1">${mount.error}</div>` : ''}
                        </div>
                    `;
                });

                html += '</div></div>';
            }

            // Memory Stats
            if (rclone.memory) {
                html += `
                    <div class="mb-4">
                        <h3 class="font-semibold mb-2 flex items-center gap-2">
                            <i class="bi bi-memory text-warning"></i>
                            Memory Usage
                        </h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div class="stat bg-base-200 rounded-lg p-3">
                                <div class="stat-title text-xs">System Memory</div>
                                <div class="stat-value text-sm">${window.decypharrUtils.formatBytes(rclone.memory.Sys || 0)}</div>
                            </div>
                            <div class="stat bg-base-200 rounded-lg p-3">
                                <div class="stat-title text-xs">Heap Alloc</div>
                                <div class="stat-value text-sm">${window.decypharrUtils.formatBytes(rclone.memory.HeapAlloc || 0)}</div>
                            </div>
                            <div class="stat bg-base-200 rounded-lg p-3">
                                <div class="stat-title text-xs">Total Alloc</div>
                                <div class="stat-value text-sm">${window.decypharrUtils.formatBytes(rclone.memory.TotalAlloc || 0)}</div>
                            </div>
                            <div class="stat bg-base-200 rounded-lg p-3">
                                <div class="stat-title text-xs">Heap Objects</div>
                                <div class="stat-value text-sm">${(rclone.memory.HeapObjects || 0).toLocaleString()}</div>
                            </div>
                        </div>
                    </div>
                `;
            }

            // Bandwidth Limits
            if (rclone.bandwidth && rclone.bandwidth.rate !== "off") {
                html += `
                    <div class="mb-4">
                        <h3 class="font-semibold mb-2 flex items-center gap-2">
                            <i class="bi bi-speedometer2 text-info"></i>
                            Bandwidth Limits
                        </h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="stat bg-base-200 rounded-lg p-3">
                                <div class="stat-title text-xs">Bytes Per Second</div>
                                <div class="stat-value text-sm">${window.decypharrUtils.formatBytes(rclone.bandwidth.bytesPerSecond || 0)}</div>
                            </div>
                            <div class="stat bg-base-200 rounded-lg p-3">
                                <div class="stat-title text-xs">Rate Limit</div>
                                <div class="stat-value text-sm">${rclone.bandwidth.rate || '-'}</div>
                            </div>
                        </div>
                    </div>
                `;
            }

            contentEl.innerHTML = html || '<p class="text-center opacity-50 py-4">No rclone data available</p>';
        }

        function updateDebridStats(debrids) {
            const debridContent = document.getElementById('debrid-content');

            if (!debrids || debrids.length === 0) {
                debridContent.innerHTML = '<p class="text-base-content/70">No debrid services configured.</p>';
                return;
            }

            let html = '<div class="space-y-4">';
            debrids.forEach(debrid => {
                const profile = debrid.profile || {};
                const library = debrid.library || {};
                const accounts = debrid.accounts || [];
                
                html += `
                    <div class="card bg-base-200">
                        <div class="card-body p-4">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h3 class="card-title text-lg">${profile.name || 'Unknown Service'}</h3>
                                    <p class="text-sm text-base-content/70">${profile.username || 'No username'}</p>
                                </div>
                                <div class="text-right">
                                    <div class="text-sm font-mono">${formatNumber(profile.points || 0)} points</div>
                                    <div class="text-xs text-base-content/70">Type: ${profile.type || 'Unknown'}</div>
                                    <div class="text-xs text-base-content/70">Expires: ${profile.expiration ? new Date(profile.expiration).toLocaleDateString() : 'Unknown'}</div>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mt-4">
                                <div class="stat">
                                    <div class="stat-title text-xs">Library Size</div>
                                    <div class="stat-value text-sm">${formatNumber(library.total || 0)}</div>
                                </div>
                                <div class="stat">
                                    <div class="stat-title text-xs">Bad Torrents</div>
                                    <div class="stat-value text-sm text-error">${formatNumber(library.bad || 0)}</div>
                                </div>
                                <div class="stat">
                                    <div class="stat-title text-xs">Active Links</div>
                                    <div class="stat-value text-sm text-success">${formatNumber(library.active_links || 0)}</div>
                                </div>
                                <div class="stat">
                                    <div class="stat-title text-xs">Total Accounts</div>
                                    <div class="stat-value text-sm text-info">${accounts.length}</div>
                                </div>
                            </div>
                `;
                
                // Add accounts section if there are accounts
                if (accounts && accounts.length > 0) {
                    html += `
                        <div class="mt-6">
                            <h4 class="text-lg font-semibold mb-3">
                                <i class="bi bi-person-lines-fill text-primary"></i>
                                Accounts
                            </h4>
                            <div class="grid grid-cols-2 md:grid-cols-2 gap-2">
                    `;
                    
                    accounts.forEach((account, index) => {
                        const statusBadge = account.disabled ? 
                            '<span class="badge badge-error badge-sm">Disabled</span>' : 
                            '<span class="badge badge-success badge-sm">Active</span>';
                        const inUseBadge = account.in_use ?
                            '<span class="badge badge-info badge-sm">In Use</span>' :
                            '';
                        
                        html += `
                            <div class="card bg-base-100 compact">
                                <div class="card-body p-3">
                                    <div class="flex justify-between items-start mb-2">
                                        <div class="flex-1">
                                            <div class="flex items-center gap-2">
                                                <h5 class="font-medium text-sm">Account #${account.order + 1}</h5>
                                                ${statusBadge}
                                                ${inUseBadge}
                                            </div>
                                            <p class="text-xs text-base-content/70 mt-1">${account.username || 'No username'}</p>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-xs font-mono text-base-content/80">
                                                Token: ${account.token_masked || '****'}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-2 md:grid-cols-2 gap-2">
                                        <div class="stat bg-base-200 rounded p-2">
                                            <div class="stat-title text-xs">Traffic Used</div>
                                            <div class="stat-value text-xs">${window.decypharrUtils.formatBytes(account.traffic_used || 0)}</div>
                                        </div>
                                        <div class="stat bg-base-200 rounded p-2">
                                            <div class="stat-title text-xs">Links Count</div>
                                            <div class="stat-value text-xs">${formatNumber(account.links_count || 0)}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += '</div></div>';
                }
                
                html += `
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            debridContent.innerHTML = html;
        }

        function updateStats(stats) {
            // System overview
            document.getElementById('memory-used').textContent = stats.memory_used || '-';
            document.getElementById('heap-alloc').textContent = `Heap: ${stats.heap_alloc_mb || '-'}`;
            document.getElementById('goroutines').textContent = formatNumber(stats.goroutines || 0);
            document.getElementById('gc-cycles').textContent = `GC: ${formatNumber(stats.gc_cycles || 0)} cycles`;
            document.getElementById('num-cpu').textContent = stats.num_cpu || '-';
            document.getElementById('arch').textContent = stats.arch || '-';
            document.getElementById('os').textContent = stats.os || '-';
            document.getElementById('go-version').textContent = stats.go_version || '-';

            // Rclone stats
            updateRcloneStats(stats.rclone);

            // Debrid stats
            updateDebridStats(stats.debrids);
        }

        function loadStats() {
            showLoading();

            fetch(`${window.urlBase}debug/stats`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(stats => {
                    updateStats(stats);
                    showContent();
                })
                .catch(error => {
                    console.error('Error loading stats:', error);
                    showError(error.message || 'Failed to load statistics');
                });
        }

        // Event listeners
        refreshBtn.addEventListener('click', loadStats);
        retryBtn.addEventListener('click', loadStats);

        // Auto-refresh every 30 seconds
        setInterval(loadStats, 30000);

        // Initial load
        loadStats();
    });
</script>
{{ end }}